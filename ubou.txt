#include <stdio.h>
#include <stdlib.h>
#include <pthread.h>
#include <semaphore.h>
#include <unistd.h>

// Node structure for unbounded buffer
typedef struct Node {
    int data;
    struct Node* next;
} Node;

Node* head = NULL;
Node* tail = NULL;

pthread_mutex_t mutex;
sem_t items; // counts available items

// Produce an item
void produce(int item) {
    Node* newNode = (Node*)malloc(sizeof(Node));
    newNode->data = item;
    newNode->next = NULL;

    pthread_mutex_lock(&mutex);
    if (tail == NULL) {  // buffer empty
        head = tail = newNode;
    } else {
        tail->next = newNode;
        tail = newNode;
    }
    pthread_mutex_unlock(&mutex);
    sem_post(&items); // signal that a new item is available
}

// Consume an item
int consume() {
    sem_wait(&items);  // wait if buffer empty

    pthread_mutex_lock(&mutex);
    Node* temp = head;
    int item = temp->data;
    head = head->next;
    if (head == NULL) tail = NULL; // buffer empty
    pthread_mutex_unlock(&mutex);

    free(temp);
    return item;
}

// Producer thread
void* producer_thread(void* arg) {
    for (int i = 0; i < 10; i++) {
        printf("Producing %d\n", i);
        produce(i);
        sleep(1);
    }
    return NULL;
}

// Consumer thread
void* consumer_thread(void* arg) {
    for (int i = 0; i < 10; i++) {
        int item = consume();
        printf("Consumed %d\n", item);
        sleep(2);
    }
    return NULL;
}

int main() {
    pthread_t prod, cons;

    pthread_mutex_init(&mutex, NULL);
    sem_init(&items, 0, 0);  // initially no items

    pthread_create(&prod, NULL, producer_thread, NULL);
    pthread_create(&cons, NULL, consumer_thread, NULL);

    pthread_join(prod, NULL);
    pthread_join(cons, NULL);

    pthread_mutex_destroy(&mutex);
    sem_destroy(&items);

    return 0;
}
